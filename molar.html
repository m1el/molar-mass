<script type="text/javascript">
const periodic=[
{"name":"Hydro­gen","z":1,"sym":"H","mass":1.008},
{"name":"He­lium","z":2,"sym":"He","mass":4.0026},
{"name":"Lith­ium","z":3,"sym":"Li","mass":6.94},
{"name":"Beryl­lium","z":4,"sym":"Be","mass":9.0122},
{"name":"Boron","z":5,"sym":"B","mass":10.81},
{"name":"Carbon","z":6,"sym":"C","mass":12.011},
{"name":"Nitro­gen","z":7,"sym":"N","mass":14.007},
{"name":"Oxy­gen","z":8,"sym":"O","mass":15.999},
{"name":"Fluor­ine","z":9,"sym":"F","mass":18.998},
{"name":"Neon","z":10,"sym":"Ne","mass":20.18},
{"name":"So­dium","z":11,"sym":"Na","mass":22.99},
{"name":"Magne­sium","z":12,"sym":"Mg","mass":24.305},
{"name":"Alumin­ium","z":13,"sym":"Al","mass":26.982},
{"name":"Sili­con","z":14,"sym":"Si","mass":28.085},
{"name":"Phos­phorus","z":15,"sym":"P","mass":30.974},
{"name":"Sulfur","z":16,"sym":"S","mass":32.06},
{"name":"Chlor­ine","z":17,"sym":"Cl","mass":35.45},
{"name":"Argon","z":18,"sym":"Ar","mass":39.95},
{"name":"Potas­sium","z":19,"sym":"K","mass":39.098},
{"name":"Cal­cium","z":20,"sym":"Ca","mass":40.078},
{"name":"Scan­dium","z":21,"sym":"Sc","mass":44.956},
{"name":"Tita­nium","z":22,"sym":"Ti","mass":47.867},
{"name":"Vana­dium","z":23,"sym":"V","mass":50.942},
{"name":"Chrom­ium","z":24,"sym":"Cr","mass":51.996},
{"name":"Manga­nese","z":25,"sym":"Mn","mass":54.938},
{"name":"Iron","z":26,"sym":"Fe","mass":55.845},
{"name":"Cobalt","z":27,"sym":"Co","mass":58.933},
{"name":"Nickel","z":28,"sym":"Ni","mass":58.693},
{"name":"Copper","z":29,"sym":"Cu","mass":63.546},
{"name":"Zinc","z":30,"sym":"Zn","mass":65.38},
{"name":"Gallium","z":31,"sym":"Ga","mass":69.723},
{"name":"Germa­nium","z":32,"sym":"Ge","mass":72.63},
{"name":"Arsenic","z":33,"sym":"As","mass":74.922},
{"name":"Sele­nium","z":34,"sym":"Se","mass":78.971},
{"name":"Bromine","z":35,"sym":"Br","mass":79.904},
{"name":"Kryp­ton","z":36,"sym":"Kr","mass":83.798},
{"name":"Rubid­ium","z":37,"sym":"Rb","mass":85.468},
{"name":"Stront­ium","z":38,"sym":"Sr","mass":87.62},
{"name":"Yttrium","z":39,"sym":"Y","mass":88.906},
{"name":"Zirco­nium","z":40,"sym":"Zr","mass":91.224},
{"name":"Nio­bium","z":41,"sym":"Nb","mass":92.906},
{"name":"Molyb­denum","z":42,"sym":"Mo","mass":95.95},
{"name":"Tech­netium","z":43,"sym":"Tc","mass":97},
{"name":"Ruthe­nium","z":44,"sym":"Ru","mass":101.07},
{"name":"Rho­dium","z":45,"sym":"Rh","mass":102.91},
{"name":"Pallad­ium","z":46,"sym":"Pd","mass":106.42},
{"name":"Silver","z":47,"sym":"Ag","mass":107.87},
{"name":"Cad­mium","z":48,"sym":"Cd","mass":112.41},
{"name":"Indium","z":49,"sym":"In","mass":114.82},
{"name":"Tin","z":50,"sym":"Sn","mass":118.71},
{"name":"Anti­mony","z":51,"sym":"Sb","mass":121.76},
{"name":"Tellur­ium","z":52,"sym":"Te","mass":127.6},
{"name":"Iodine","z":53,"sym":"I","mass":126.9},
{"name":"Xenon","z":54,"sym":"Xe","mass":131.29},
{"name":"Cae­sium","z":55,"sym":"Cs","mass":132.91},
{"name":"Ba­rium","z":56,"sym":"Ba","mass":137.33},
{"name":"Lan­thanum","z":57,"sym":"La","mass":138.91},
{"name":"Cerium","z":58,"sym":"Ce","mass":140.12},
{"name":"Praseo­dymium","z":59,"sym":"Pr","mass":140.91},
{"name":"Neo­dymium","z":60,"sym":"Nd","mass":144.24},
{"name":"Prome­thium","z":61,"sym":"Pm","mass":145},
{"name":"Sama­rium","z":62,"sym":"Sm","mass":150.36},
{"name":"Europ­ium","z":63,"sym":"Eu","mass":151.96},
{"name":"Gadolin­ium","z":64,"sym":"Gd","mass":157.25},
{"name":"Ter­bium","z":65,"sym":"Tb","mass":158.93},
{"name":"Dyspro­sium","z":66,"sym":"Dy","mass":162.5},
{"name":"Hol­mium","z":67,"sym":"Ho","mass":164.93},
{"name":"Erbium","z":68,"sym":"Er","mass":167.26},
{"name":"Thulium","z":69,"sym":"Tm","mass":168.93},
{"name":"Ytter­bium","z":70,"sym":"Yb","mass":173.05},
{"name":"Lute­tium","z":71,"sym":"Lu","mass":174.97},
{"name":"Haf­nium","z":72,"sym":"Hf","mass":178.49},
{"name":"Tanta­lum","z":73,"sym":"Ta","mass":180.95},
{"name":"Tung­sten","z":74,"sym":"W","mass":183.84},
{"name":"Rhe­nium","z":75,"sym":"Re","mass":186.21},
{"name":"Os­mium","z":76,"sym":"Os","mass":190.23},
{"name":"Iridium","z":77,"sym":"Ir","mass":192.22},
{"name":"Plat­inum","z":78,"sym":"Pt","mass":195.08},
{"name":"Gold","z":79,"sym":"Au","mass":196.97},
{"name":"Mer­cury","z":80,"sym":"Hg","mass":200.59},
{"name":"Thallium","z":81,"sym":"Tl","mass":204.38},
{"name":"Lead","z":82,"sym":"Pb","mass":207.2},
{"name":"Bis­muth","z":83,"sym":"Bi","mass":208.98},
{"name":"Polo­nium","z":84,"sym":"Po","mass":209},
{"name":"Asta­tine","z":85,"sym":"At","mass":210},
{"name":"Radon","z":86,"sym":"Rn","mass":222},
{"name":"Fran­cium","z":87,"sym":"Fr","mass":223},
{"name":"Ra­dium","z":88,"sym":"Ra","mass":226},
{"name":"Actin­ium","z":89,"sym":"Ac","mass":227},
{"name":"Thor­ium","z":90,"sym":"Th","mass":232.04},
{"name":"Protac­tinium","z":91,"sym":"Pa","mass":231.04},
{"name":"Ura­nium","z":92,"sym":"U","mass":238.03},
{"name":"Neptu­nium","z":93,"sym":"Np","mass":237},
{"name":"Pluto­nium","z":94,"sym":"Pu","mass":244},
{"name":"Ameri­cium","z":95,"sym":"Am","mass":243},
{"name":"Curium","z":96,"sym":"Cm","mass":247},
{"name":"Berkel­ium","z":97,"sym":"Bk","mass":247},
{"name":"Califor­nium","z":98,"sym":"Cf","mass":251},
{"name":"Einstei­nium","z":99,"sym":"Es","mass":252},
{"name":"Fer­mium","z":100,"sym":"Fm","mass":257},
{"name":"Mende­levium","z":101,"sym":"Md","mass":258},
{"name":"Nobel­ium","z":102,"sym":"No","mass":259},
{"name":"Lawren­cium","z":103,"sym":"Lr","mass":266},
{"name":"Ruther­fordium","z":104,"sym":"Rf","mass":267},
{"name":"Dub­nium","z":105,"sym":"Db","mass":268},
{"name":"Sea­borgium","z":106,"sym":"Sg","mass":269},
{"name":"Bohr­ium","z":107,"sym":"Bh","mass":270},
{"name":"Has­sium","z":108,"sym":"Hs","mass":269},
{"name":"Meit­nerium","z":109,"sym":"Mt","mass":278},
{"name":"Darm­stadtium","z":110,"sym":"Ds","mass":281},
{"name":"Roent­genium","z":111,"sym":"Rg","mass":282},
{"name":"Coper­nicium","z":112,"sym":"Cn","mass":285},
{"name":"Nihon­ium","z":113,"sym":"Nh","mass":286},
{"name":"Flerov­ium","z":114,"sym":"Fl","mass":289},
{"name":"Moscov­ium","z":115,"sym":"Mc","mass":290},
{"name":"Liver­morium","z":116,"sym":"Lv","mass":293},
{"name":"Tenness­ine","z":117,"sym":"Ts","mass":294},
{"name":"Oga­nesson","z":118,"sym":"Og","mass":294},
];
const elementMap={};
periodic.forEach((el) => elementMap[el.sym] = el);

const tokenize = (str) => {
    const symRe = /^([A-Z][a-z]?|[a-z])/;
    const numRe = /^(\d+)/;
    const wsRe = /^\s+/;
    const next = () => {
        str = str.replace(wsRe, '');
        if (str === '') {
            return 'EOF';
        }
        const head = str[0];
        if (head === '(' || head == ')') {
            str = str.substr(1);
            return head;
        }
        const symMatch = symRe.exec(str);
        if (symMatch) {
            const sym = symMatch[1];
            str = str.substr(sym.length);
            return sym;
        }
        const numMatch = numRe.exec(str);
        if (numMatch) {
            const num = numMatch[1];
            str = str.substr(num.length);
            return Number(num);
        }
        throw new Error('unknown token here: ' + str);
    };
    next.str = () => str;
    return next;
};

const peekable = (next) => {
    let peeked = false;
    let value = null;

    const peekable = () => {
        if (peeked) {
            peeked = false;
            const ret = value;
            value = null;
            return ret;
        } else {
            return next();
        }
    };

    peekable.peek = () => {
        if (!peeked) {
            value = next();
            peeked = true;
        }
        return value;
    };

    peekable.str = () => next.str();

    return peekable;
};

const parseInner = (tokenizer, end='EOF') => {
    let token;
    const rv = [];
    while ((token = tokenizer())) {
        if (token === 'EOF' || token === ')') {
            if (token === end) {
                return rv;
            } else {
                throw new Error('unmatched parenthesis!');
            }
        }
        if (token === '(') {
            const group = parseInner(tokenizer, ')');
            const value = {kind: 'group', items: group, repeat: 1};
            const next = tokenizer.peek();
            if (typeof next === 'number') {
                tokenizer(); // consume
                value.repeat = next;
            }
            rv.push(value);
        } else if (typeof token === 'string') {
            const value = {kind: 'element', sym: token, repeat: 1};
            const next = tokenizer.peek();
            if (typeof next === 'number') {
                tokenizer(); // consume
                value.repeat = next;
            }
            rv.push(value);
        } else {
            throw new Error('unknown token at: ' + tokenizer.str());
        }
    }
};

const parse = (str) =>
    parseInner(peekable(tokenize(str)), 'EOF');

const molar = (f) =>
    f.reduce((acc, item) => {
        let m;
        if (item.kind === 'element') {
            const data = elementMap[item.sym] ||
                // try again with uppercase
                elementMap[item.sym.toUpperCase()];
            if (!data) { throw new Error('unknown element: ' + item.sym); }
            m = data.mass * item.repeat;
        } else if (item.kind === 'group') {
            m = molar(item.items) * item.repeat;
        } else {
            throw new Error('unknown item in formula:', JSON.stringify(item));
        }
        return acc + m;
    }, 0);

window.onload = () => {
    const update = () => {
        const formula = parse(inp.value);
        out.value = molar(formula);
    }

    form.onsubmit = () => {
        update();
        return false;
    };

    btn.onclick = update;
};
</script>
<style>
input {
    font-size: 2em;
}
</style>
<form id="form">
<input type="text" autocomplete="off" id="inp"><input type="submit" id="btn" value="calc"><br>
<input type="text" id="out">
</form>

